name: reusable-ci

on:
  workflow_call:
    inputs:
      node-version:
        description: Node.js version
        required: false
        default: '20'
        type: string
      run-coverage:
        description: Run coverage step
        required: false
        default: true
        type: boolean
      enable-drift-check:
        description: Run DevKit drift check (fails on drift)
        required: false
        default: true
        type: boolean

jobs:
  drift:
    if: ${{ inputs.enable-drift-check == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-drift
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - uses: KirillBaranov/kb-labs-devkit/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs['node-version'] }}
      - name: Install deps
        run: pnpm i --frozen-lockfile
      - name: DevKit drift check
        # Repos are expected to ship a script `devkit:check` that runs the sync tool in check mode
        run: pnpm -s devkit:check

  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-validate
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - uses: KirillBaranov/kb-labs-devkit/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs['node-version'] }}
      - name: Install deps
        run: pnpm i --frozen-lockfile
      - name: Lint
        run: pnpm lint
      - name: Type check
        run: pnpm type-check || true

  build:
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: KirillBaranov/kb-labs-devkit/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs['node-version'] }}
      - name: Install deps
        run: pnpm i --frozen-lockfile
      - name: Build (workspace)
        run: pnpm -r run build || true
      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: |
            packages/**/dist/
            dist/
          if-no-files-found: ignore

  test:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: KirillBaranov/kb-labs-devkit/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs['node-version'] }}
      - name: Install deps
        run: pnpm i --frozen-lockfile
      - name: Download build outputs
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: .
      - name: Test (no watch)
        run: pnpm test -- --run

  coverage:
    if: ${{ inputs['run-coverage'] == true }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: KirillBaranov/kb-labs-devkit/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs['node-version'] }}
      - name: Install deps
        run: pnpm i --frozen-lockfile
      - name: Download build outputs
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: .
      - name: Coverage
        run: pnpm test:coverage
      - name: Upload coverage (if any)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: |
            coverage/
            **/coverage/
          if-no-files-found: ignore
