# ADR-0011: Preventing Workspace Package Bundling in tsup

**Date:** 2025-11-19
**Status:** Accepted
**Deciders:** KB Labs Team
**Last Reviewed:** 2025-11-19
**Tags:** [tooling, bundling, monorepo]

## Context

In KB Labs monorepos, we use `tsup` for bundling TypeScript packages. A critical issue emerged where workspace packages (`@kb-labs/*`) were being accidentally bundled into consuming packages, leading to:

1. **Module duplication**: Multiple instances of the same module in runtime, causing inconsistent global state (e.g., logging `globalLevel` not shared)
2. **Large bundle sizes**: Packages that should be external dependencies were bundled, increasing bundle size significantly (e.g., 1MB+ instead of ~300KB)
3. **Runtime errors**: Missing dependencies at runtime because transitive dependencies were bundled but not available
4. **Debugging difficulties**: Logs and state management systems failed because they relied on singleton patterns that broke with module duplication

The root cause was identified as:
- **`tsconfig.paths.json`**: Maps workspace package names to their source file paths, which `tsup`/`esbuild` resolves during bundling
- **tsup's module resolution**: When `tsup` reads `tsconfig.json` with `paths`, it resolves workspace imports to source files and bundles them instead of treating them as external

## Decision

We implement a two-part solution to prevent workspace package bundling:

### 1. Build-specific TypeScript configuration (`tsconfig.build.json`)

Create a separate `tsconfig.build.json` for each package that:
- Extends the base `tsconfig.json` (for IDE support and type-checking)
- Explicitly sets `paths: {}` to prevent tsup from resolving workspace packages to source files
- Is automatically generated by `kb-devkit-sync` for all packages with `tsup.config.ts`

**Usage in `tsup.config.ts`:**
```typescript
import { defineConfig } from 'tsup';
import nodePreset from '@kb-labs/devkit/tsup/node.js';

export default defineConfig({
  ...nodePreset,
  entry: { index: "src/index.ts" },
  tsconfig: "tsconfig.build.json", // Use build config without paths
});
```

### 2. External dependencies list (`tsup.external.json`)

Generate `tsup.external.json` at the repository root that:
- Lists all `@kb-labs/*` workspace packages (discovered via `pnpm-workspace.yaml`)
- Lists all `dependencies` and `peerDependencies` from `package.json`
- Is automatically generated by `kb-devkit-tsup-external` (runs in `postinstall`)
- Is read by `@kb-labs/devkit/tsup/node.js` preset to mark packages as external

**Generation:**
```bash
# Automatic (via postinstall)
pnpm install

# Manual
kb-devkit-tsup-external --generate
```

## Rationale

### Why `tsconfig.build.json`?

- **Separation of concerns**: IDE/type-checking config (`tsconfig.json`) vs build config (`tsconfig.build.json`)
- **Prevents path resolution**: Empty `paths: {}` ensures tsup doesn't resolve workspace packages to source files
- **Automatic generation**: DevKit sync generates it automatically, no manual maintenance
- **Backward compatible**: Existing `tsconfig.json` remains unchanged for IDE support

### Why `tsup.external.json`?

- **Explicit external list**: Ensures all workspace packages are marked as external
- **Catches transitive deps**: Includes dependencies that might be bundled accidentally
- **Workspace-aware**: Automatically discovers all `@kb-labs/*` packages via workspace config
- **Single source of truth**: Generated once per repository, used by all packages

### Why not other approaches?

- **`bundle: false`**: Breaks internal imports within packages (relative imports need `.js` extensions)
- **Manual `external` array**: Error-prone, requires manual updates, doesn't catch transitive deps
- **Regex patterns**: Less reliable, doesn't handle edge cases (e.g., `link:` protocol dependencies)
- **`noExternal: []`**: Prevents bundling node_modules but doesn't solve workspace package resolution

## Consequences

**Pros**
- **Automatic**: No manual configuration needed after initial setup
- **Consistent**: All packages use the same approach
- **Reliable**: Catches all workspace packages and dependencies
- **Maintainable**: DevKit sync keeps configurations up-to-date
- **Smaller bundles**: Only application code is bundled, dependencies remain external
- **Correct module resolution**: Single instance of each module in runtime

**Cons**
- **Additional config file**: `tsconfig.build.json` per package (but auto-generated)
- **Dependency on DevKit**: Requires DevKit sync to be run periodically
- **Explicit dependencies**: Transitive dependencies that were previously bundled now need to be explicit in `package.json`

## Operational Notes

### Automatic Setup

1. **Run DevKit sync** to generate `tsconfig.build.json`:
   ```bash
   pnpm devkit:sync
   ```

2. **Update `tsup.config.ts`** to use `tsconfig.build.json`:
   ```typescript
   tsconfig: "tsconfig.build.json"
   ```

3. **Generate `tsup.external.json`** (automatic via `postinstall`):
   ```bash
   pnpm install
   ```

### Manual Steps (if needed)

1. **Add missing dependencies**: If a transitive dependency is now external but missing:
   ```bash
   pnpm add <package-name> --filter <package-name>
   ```

2. **Regenerate external list**:
   ```bash
   kb-devkit-tsup-external --generate
   ```

### Verification

1. **Check bundle size**: Should be significantly smaller (e.g., 300KB instead of 1MB+)
2. **Check imports**: `dist/*.js` should contain `import ... from '@kb-labs/...'` statements (external imports)
3. **Check runtime**: CLI/application should work correctly with external dependencies
4. **Check logs**: Debug logs should work correctly (no module duplication)

## Migration Guide

### For Existing Packages

1. **Update DevKit** to latest version (includes sync changes)

2. **Run sync** to generate `tsconfig.build.json`:
   ```bash
   pnpm devkit:sync
   ```

3. **Update `tsup.config.ts`** in each package:
   ```typescript
   // Before
   export default defineConfig({
     ...nodePreset,
     entry: { index: "src/index.ts" },
   });

   // After
   export default defineConfig({
     ...nodePreset,
     entry: { index: "src/index.ts" },
     tsconfig: "tsconfig.build.json", // Add this line
   });
   ```

4. **Install dependencies** to generate `tsup.external.json`:
   ```bash
   pnpm install
   ```

5. **Rebuild packages**:
   ```bash
   pnpm build --filter <package-name>
   ```

6. **Verify bundle size** and check for missing dependencies:
   ```bash
   ls -lh packages/<package-name>/dist/*.js
   ```

7. **Add missing dependencies** if runtime errors occur:
   ```bash
   pnpm add <missing-package> --filter <package-name>
   ```

### For New Packages

1. **Use DevKit preset** in `tsup.config.ts`:
   ```typescript
   import { defineConfig } from 'tsup';
   import nodePreset from '@kb-labs/devkit/tsup/node.js';

   export default defineConfig({
     ...nodePreset,
     entry: { index: "src/index.ts" },
     tsconfig: "tsconfig.build.json",
   });
   ```

2. **Run sync** to generate `tsconfig.build.json`:
   ```bash
   pnpm devkit:sync
   ```

3. **Build and verify**:
   ```bash
   pnpm build --filter <package-name>
   ```

## Examples

### Before (Problematic)

**`tsup.config.ts`:**
```typescript
export default defineConfig({
  entry: { index: "src/index.ts" },
  // Uses tsconfig.json with paths → bundles workspace packages
});
```

**Result:**
- Bundle size: 1.0MB+
- Workspace packages bundled: `@kb-labs/core-sys`, `@kb-labs/cli-core`, etc.
- Module duplication: Multiple instances of logging module
- Runtime errors: Missing dependencies

### After (Fixed)

**`tsup.config.ts`:**
```typescript
import { defineConfig } from 'tsup';
import nodePreset from '@kb-labs/devkit/tsup/node.js';

export default defineConfig({
  ...nodePreset,
  entry: { index: "src/index.ts" },
  tsconfig: "tsconfig.build.json", // Uses config without paths
});
```

**`tsconfig.build.json`** (auto-generated):
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "dist",
    "baseUrl": ".",
    "paths": {}
  },
  "include": ["src/**/*"],
  "exclude": ["dist", "node_modules"]
}
```

**Result:**
- Bundle size: ~300KB
- Workspace packages external: `import ... from '@kb-labs/core-sys'`
- Single module instance: Correct singleton behavior
- No runtime errors: All dependencies available

## Alternatives Considered

1. **`bundle: false`**: 
   - ❌ Breaks relative imports (need `.js` extensions)
   - ❌ More complex configuration

2. **Manual `external` array**:
   - ❌ Error-prone, requires manual updates
   - ❌ Doesn't catch transitive dependencies
   - ❌ Doesn't scale across many packages

3. **Regex patterns in `external`**:
   - ❌ Less reliable for edge cases
   - ❌ Doesn't handle `link:` protocol dependencies

4. **`noExternal: []`**:
   - ❌ Prevents bundling node_modules but doesn't solve workspace resolution
   - ❌ Still bundles workspace packages if paths are present

5. **Remove `tsconfig.paths.json`**:
   - ❌ Breaks IDE support and type-checking
   - ❌ Developers lose autocomplete and type checking

## Follow-ups

- [x] Implement automatic generation of `tsconfig.build.json` in DevKit sync
- [x] Implement automatic generation of `tsup.external.json` in postinstall
- [x] Update all existing packages to use `tsconfig.build.json`
- [ ] Add fixture test to verify workspace packages are not bundled
- [ ] Document in DevKit README
- [ ] Add migration checklist for new packages

## References

- ADR-0005: Build & Types Strategy for KB Labs Monorepos
- ADR-0010: Global tsconfig.paths.json Strategy
- [tsup documentation](https://tsup.egoist.dev/)
- [esbuild external dependencies](https://esbuild.github.io/api/#external)

